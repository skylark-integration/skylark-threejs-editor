{"version":3,"sources":["menuitems/File.js"],"names":["define","THREE","ColladaExporter","DRACOExporter","GLTFExporter","OBJExporter","PLYExporter","STLExporter","mrdoobui","MenubarFile","editor","parseNumber","key","value","precision","config","getKey","parseFloat","toFixed","strings","container","UIPanel","setClass","title","setTextContent","add","options","option","UIRow","onClick","confirm","clear","UIHorizontalRule","form","document","createElement","style","display","body","appendChild","fileInput","multiple","type","addEventListener","loader","loadFiles","files","reset","click","object","selected","geometry","undefined","output","toJSON","JSON","stringify","replace","e","saveString","alert","scene","parse","result","data","isMesh","saveArrayBuffer","binary","forceIndices","forcePowerOfTwoTextures","zip","JSZip","metadata","history","file","manager","LoadingManager","save","generate","FileLoader","load","content","join","editButton","link","blob","filename","href","URL","createObjectURL","download","dispatchEvent","MouseEvent","buffer","Blob","text"],"mappings":"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","file":"../../menuitems/File.js","sourcesContent":["define([\n    'skylark-threejs',\n    'skylark-threejs-ex/exporters/ColladaExporter',\n    'skylark-threejs-ex/exporters/DRACOExporter',\n    'skylark-threejs-ex/exporters/GLTFExporter',\n    'skylark-threejs-ex/exporters/OBJExporter',\n    'skylark-threejs-ex/exporters/PLYExporter',\n    'skylark-threejs-ex/exporters/STLExporter',\n    'skylark-mrdoobui'\n], function (\n    THREE, \n    ColladaExporter, \n    DRACOExporter, \n    GLTFExporter, \n    OBJExporter, \n    PLYExporter, \n    STLExporter, \n    mrdoobui\n) {\n    'use strict';\n    var MenubarFile = function (editor) {\n        function parseNumber(key, value) {\n            var precision = config.getKey('exportPrecision');\n            return typeof value === 'number' ? parseFloat(value.toFixed(precision)) : value;\n        }\n        var config = editor.config;\n        var strings = editor.strings;\n        var container = new mrdoobui.UIPanel();\n        container.setClass('menu');\n        var title = new mrdoobui.UIPanel();\n        title.setClass('title');\n        title.setTextContent(strings.getKey('menubar/file'));\n        container.add(title);\n        var options = new mrdoobui.UIPanel();\n        options.setClass('options');\n        container.add(options);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/new'));\n        option.onClick(function () {\n            if (confirm('Any unsaved data will be lost. Are you sure?')) {\n                editor.clear();\n            }\n        });\n        options.add(option);\n        options.add(new mrdoobui.UIHorizontalRule());\n        var form = document.createElement('form');\n        form.style.display = 'none';\n        document.body.appendChild(form);\n        var fileInput = document.createElement('input');\n        fileInput.multiple = true;\n        fileInput.type = 'file';\n        fileInput.addEventListener('change', function () {\n            editor.loader.loadFiles(fileInput.files);\n            form.reset();\n        });\n        form.appendChild(fileInput);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/import'));\n        option.onClick(function () {\n            fileInput.click();\n        });\n        options.add(option);\n        options.add(new mrdoobui.UIHorizontalRule());\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/geometry'));\n        option.onClick(function () {\n            var object = editor.selected;\n            if (object === null) {\n                alert('No object selected.');\n                return;\n            }\n            var geometry = object.geometry;\n            if (geometry === undefined) {\n                alert(\"The selected object doesn't have geometry.\");\n                return;\n            }\n            var output = geometry.toJSON();\n            try {\n                output = JSON.stringify(output, parseNumber, '\\t');\n                output = output.replace(/[\\n\\t]+([\\d\\.e\\-\\[\\]]+)/g, '$1');\n            } catch (e) {\n                output = JSON.stringify(output);\n            }\n            saveString(output, 'geometry.json');\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/object'));\n        option.onClick(function () {\n            var object = editor.selected;\n            if (object === null) {\n                alert('No object selected');\n                return;\n            }\n            var output = object.toJSON();\n            try {\n                output = JSON.stringify(output, parseNumber, '\\t');\n                output = output.replace(/[\\n\\t]+([\\d\\.e\\-\\[\\]]+)/g, '$1');\n            } catch (e) {\n                output = JSON.stringify(output);\n            }\n            saveString(output, 'model.json');\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/scene'));\n        option.onClick(function () {\n            var output = editor.scene.toJSON();\n            try {\n                output = JSON.stringify(output, parseNumber, '\\t');\n                output = output.replace(/[\\n\\t]+([\\d\\.e\\-\\[\\]]+)/g, '$1');\n            } catch (e) {\n                output = JSON.stringify(output);\n            }\n            saveString(output, 'scene.json');\n        });\n        options.add(option);\n        options.add(new mrdoobui.UIHorizontalRule());\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/dae'));\n        option.onClick(function () {\n            var exporter = new ColladaExporter();\n            exporter.parse(editor.scene, function (result) {\n                saveString(result.data, 'scene.dae');\n            });\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/drc'));\n        option.onClick(function () {\n            var object = editor.selected;\n            if (object === null || object.isMesh === undefined) {\n                alert('No mesh selected');\n                return;\n            }\n            var exporter = new DRACOExporter();\n            var result = exporter.parse(object.geometry);\n            saveArrayBuffer(result, 'model.drc');\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/glb'));\n        option.onClick(function () {\n            var exporter = new GLTFExporter();\n            exporter.parse(editor.scene, function (result) {\n                saveArrayBuffer(result, 'scene.glb');\n            }, {\n                binary: true,\n                forceIndices: true,\n                forcePowerOfTwoTextures: true\n            });\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/gltf'));\n        option.onClick(function () {\n            var exporter = new GLTFExporter();\n            exporter.parse(editor.scene, function (result) {\n                saveString(JSON.stringify(result, null, 2), 'scene.gltf');\n            });\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/obj'));\n        option.onClick(function () {\n            var object = editor.selected;\n            if (object === null) {\n                alert('No object selected.');\n                return;\n            }\n            var exporter = new OBJExporter();\n            saveString(exporter.parse(object), 'model.obj');\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/ply'));\n        option.onClick(function () {\n            var exporter = new PLYExporter();\n            exporter.parse(editor.scene, function (result) {\n                saveArrayBuffer(result, 'model.ply');\n            });\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/ply_binary'));\n        option.onClick(function () {\n            var exporter = new PLYExporter();\n            exporter.parse(editor.scene, function (result) {\n                saveArrayBuffer(result, 'model-binary.ply');\n            }, { binary: true });\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/stl'));\n        option.onClick(function () {\n            var exporter = new STLExporter();\n            saveString(exporter.parse(editor.scene), 'model.stl');\n        });\n        options.add(option);\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/export/stl_binary'));\n        option.onClick(function () {\n            var exporter = new STLExporter();\n            saveArrayBuffer(exporter.parse(editor.scene, { binary: true }), 'model-binary.stl');\n        });\n        options.add(option);\n        options.add(new mrdoobui.UIHorizontalRule());\n        var option = new mrdoobui.UIRow();\n        option.setClass('option');\n        option.setTextContent(strings.getKey('menubar/file/publish'));\n        option.onClick(function () {\n            var zip = new JSZip();\n            var output = editor.toJSON();\n            output.metadata.type = 'App';\n            delete output.history;\n            output = JSON.stringify(output, parseNumber, '\\t');\n            output = output.replace(/[\\n\\t]+([\\d\\.e\\-\\[\\]]+)/g, '$1');\n            zip.file('app.json', output);\n            var title = config.getKey('project/title');\n            var manager = new THREE.LoadingManager(function () {\n                save(zip.generate({ type: 'blob' }), (title !== '' ? title : 'untitled') + '.zip');\n            });\n            var loader = new THREE.FileLoader(manager);\n            loader.load('js/libs/app/index.html', function (content) {\n                content = content.replace('<!-- title -->', title);\n                var includes = [];\n                content = content.replace('<!-- includes -->', includes.join('\\n\\t\\t'));\n                var editButton = '';\n                if (config.getKey('project/editable')) {\n                    editButton = [\n                        '',\n                        \"\\t\\t\\tvar button = document.createElement( 'a' );\",\n                        \"\\t\\t\\tbutton.href = 'https://threejs.org/editor/#file=' + location.href.split( '/' ).slice( 0, - 1 ).join( '/' ) + '/app.json';\",\n                        \"\\t\\t\\tbutton.style.cssText = 'position: absolute; bottom: 20px; right: 20px; padding: 10px 16px; color: #fff; border: 1px solid #fff; border-radius: 20px; text-decoration: none;';\",\n                        \"\\t\\t\\tbutton.target = '_blank';\",\n                        \"\\t\\t\\tbutton.textContent = 'EDIT';\",\n                        '\\t\\t\\tdocument.body.appendChild( button );',\n                        ''\n                    ].join('\\n');\n                }\n                content = content.replace('\\n\\t\\t\\t/* edit button */\\n', editButton);\n                zip.file('index.html', content);\n            });\n            loader.load('js/libs/app', function (content) {\n                zip.file('js/app', content);\n            });\n            loader.load('../build/three.module', function (content) {\n                zip.file('js/three.module', content);\n            });\n            loader.load('../examples/jsm/webxr/VRButton', function (content) {\n                zip.file('js/VRButton', content);\n            });\n            loader.load('../examples/js/vr/HelioWebXRPolyfill', function (content) {\n                zip.file('js/HelioWebXRPolyfill', content);\n            });\n        });\n        options.add(option);\n        var link = document.createElement('a');\n        function save(blob, filename) {\n            link.href = URL.createObjectURL(blob);\n            link.download = filename || 'data.json';\n            link.dispatchEvent(new MouseEvent('click'));\n        }\n        function saveArrayBuffer(buffer, filename) {\n            save(new Blob([buffer], { type: 'application/octet-stream' }), filename);\n        }\n        function saveString(text, filename) {\n            save(new Blob([text], { type: 'text/plain' }), filename);\n        }\n        return container;\n    };\n    return { MenubarFile };\n});"]}