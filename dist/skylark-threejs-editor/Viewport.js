/**
 * skylark-threejs-editor - A version of threejs-editor that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-editor/
 * @license MIT
 */
define(["skylark-threejs","skylark-threejs-ex/controls/TransformControls","skylark-mrdoobui","./EditorControls","./viewports/Camera","./viewports/Info","./commands/SetPositionCommand","./commands/SetRotationCommand","./commands/SetScaleCommand"],function(t,n,o,r,i,s,l,u,m){"use strict";return function(n){var r=n.signals,i=new o.UIPanel;i.setId("viewport"),i.setPosition("absolute"),i.add(new d.ViewportCamera(n)),i.add(new e.ViewportInfo(n));var s=null,l=null,u=n.camera,m=n.scene,v=n.sceneHelpers,p=[],b=new t.GridHelper(30,30,4473924,8947848);v.add(b);for(var C=b.geometry.attributes.color.array,w=0;w<C.length;w+=60)for(var x=0;x<12;x++)C[w+x]=.26;var j=new t.Box3,E=new t.BoxHelper;E.material.depthTest=!1,E.material.transparent=!0,E.visible=!1,v.add(E);var k=null,F=null,y=null,S=new a.TransformControls(u,i.dom);S.addEventListener("change",function(){var e=S.object;if(void 0!==e){E.setFromObject(e);var t=n.helpers[e.id];void 0!==t&&!0!==t.isSkeletonHelper&&t.update(),r.refreshSidebarObject3D.dispatch(e)}X()}),S.addEventListener("mouseDown",function(){var e=S.object;k=e.position.clone(),F=e.rotation.clone(),y=e.scale.clone(),B.enabled=!1}),S.addEventListener("mouseUp",function(){var e=S.object;if(void 0!==e)switch(S.getMode()){case"translate":k.equals(e.position)||n.execute(new f.SetPositionCommand(n,e,e.position,k));break;case"rotate":F.equals(e.rotation)||n.execute(new g.SetRotationCommand(n,e,e.rotation,F));break;case"scale":y.equals(e.scale)||n.execute(new h.SetScaleCommand(n,e,e.scale,y))}B.enabled=!0}),v.add(S);var A=new t.Raycaster,R=new t.Vector2;function T(e,t){return R.set(2*e.x-1,-2*e.y+1),A.setFromCamera(R,u),A.intersectObjects(t)}var L=new t.Vector2,P=new t.Vector2,H=new t.Vector2;function M(e,t,n){var o=e.getBoundingClientRect();return[(t-o.left)/o.width,(n-o.top)/o.height]}function O(){if(0===L.distanceTo(P)){var e=T(P,p);if(e.length>0){var t=e[0].object;void 0!==t.userData.object?n.select(t.userData.object):n.select(t)}else n.select(null);X()}}function D(e){var t=M(i.dom,e.clientX,e.clientY);P.fromArray(t),O(),document.removeEventListener("mouseup",D,!1)}function q(e){var t=e.changedTouches[0],n=M(i.dom,t.clientX,t.clientY);P.fromArray(n),O(),document.removeEventListener("touchend",q,!1)}i.dom.addEventListener("mousedown",function(e){var t=M(i.dom,e.clientX,e.clientY);L.fromArray(t),document.addEventListener("mouseup",D,!1)},!1),i.dom.addEventListener("touchstart",function(e){var t=e.changedTouches[0],n=M(i.dom,t.clientX,t.clientY);L.fromArray(n),document.addEventListener("touchend",q,!1)},!1),i.dom.addEventListener("dblclick",function(e){var t=M(i.dom,e.clientX,e.clientY);H.fromArray(t);var n=T(H,p);if(n.length>0){var o=n[0];r.objectFocused.dispatch(o.object)}},!1);var B=new c.EditorControls(u,i.dom);B.addEventListener("change",function(){r.cameraChanged.dispatch(u)}),r.editorCleared.add(function(){B.center.set(0,0,0),U=null,V=null,X()}),r.transformModeChanged.add(function(e){S.setMode(e)}),r.snapChanged.add(function(e){S.setTranslationSnap(e)}),r.spaceChanged.add(function(e){S.setSpace(e)}),r.rendererUpdated.add(function(){X()}),r.rendererChanged.add(function(e,n){null!==s&&i.dom.removeChild(s.domElement),l=n,(s=e).autoClear=!1,s.autoUpdateScene=!1,s.outputEncoding=t.sRGBEncoding,s.setPixelRatio(window.devicePixelRatio),s.setSize(i.dom.offsetWidth,i.dom.offsetHeight),i.dom.appendChild(s.domElement),X()}),r.sceneGraphChanged.add(function(){X()}),r.cameraChanged.add(function(){X()}),r.objectSelected.add(function(e){E.visible=!1,S.detach(),null!==e&&e!==m&&e!==u&&(j.setFromObject(e),!1===j.isEmpty()&&(E.setFromObject(e),E.visible=!0),S.attach(e)),X()}),r.objectFocused.add(function(e){B.focus(e)}),r.geometryChanged.add(function(e){void 0!==e&&E.setFromObject(e),X()}),r.objectAdded.add(function(e){e.traverse(function(e){p.push(e)})}),r.objectChanged.add(function(e){n.selected===e&&E.setFromObject(e),e.isPerspectiveCamera&&e.updateProjectionMatrix(),void 0!==n.helpers[e.id]&&n.helpers[e.id].update(),X()}),r.objectRemoved.add(function(e){B.enabled=!0,e===S.object&&S.detach(),e.traverse(function(e){p.splice(p.indexOf(e),1)})}),r.helperAdded.add(function(e){p.push(e.getObjectByName("picker"))}),r.helperRemoved.add(function(e){p.splice(p.indexOf(e.getObjectByName("picker")),1)}),r.materialChanged.add(function(){X()});var U=null;r.sceneBackgroundChanged.add(function(e,n,o,a,r){if(U!==e)switch(e){case"None":m.background=null;break;case"Color":m.background=new t.Color}if("Color"===e)m.background.set(n),m.environment=null;else if("Texture"===e)m.background=o,m.environment=null;else if("CubeTexture"===e)a&&a.isHDRTexture?((d=l.fromCubemap(a).texture).isPmremTexture=!0,m.background=d,m.environment=d):(m.background=a,m.environment=null);else if("Equirect"===e){var d;r&&r.isHDRTexture?((d=l.fromEquirectangular(r).texture).isPmremTexture=!0,m.background=d,m.environment=d):(m.background=null,m.environment=null)}X()});var V=null;r.sceneFogChanged.add(function(e,n,o,a,r){if(V!==e){switch(e){case"None":m.fog=null;break;case"Fog":m.fog=new t.Fog;break;case"FogExp2":m.fog=new t.FogExp2}V=e}m.fog&&(m.fog.isFog?(m.fog.color.setHex(n),m.fog.near=o,m.fog.far=a):m.fog.isFogExp2&&(m.fog.color.setHex(n),m.fog.density=r)),X()}),r.viewportCameraChanged.add(function(e){if(e.isPerspectiveCamera)e.aspect=n.camera.aspect,e.projectionMatrix.copy(n.camera.projectionMatrix);else if(!e.isOrthographicCamera)throw"Invalid camera set as viewport";u=e,X()}),r.windowResize.add(function(){n.DEFAULT_CAMERA.aspect=i.dom.offsetWidth/i.dom.offsetHeight,n.DEFAULT_CAMERA.updateProjectionMatrix(),u.aspect=i.dom.offsetWidth/i.dom.offsetHeight,u.updateProjectionMatrix(),s.setSize(i.dom.offsetWidth,i.dom.offsetHeight),X()}),r.showGridChanged.add(function(e){b.visible=e,X()});var W=new t.Clock;requestAnimationFrame(function e(){requestAnimationFrame(e);var t=n.mixer;t.stats.actions.inUse>0&&(t.update(W.getDelta()),X())});var I=0;function X(){I=performance.now(),m.updateMatrixWorld(),s.render(m,u),u===n.camera&&(v.updateMatrixWorld(),s.render(v,u));var e=performance.now()-I;n.signals.sceneRendered.dispatch(e)}return i}});
//# sourceMappingURL=sourcemaps/Viewport.js.map
