/**
 * skylark-threejs-editor - A version of threejs-editor that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-editor/
 * @license MIT
 */
define(["skylark-threejs","./utils/signals","./Config","./Loader","./History","./Strings","./Storage"],function(e,t,i,s,a,n,r){"use strict";var h,c,d=function(){this.DEFAULT_CAMERA=new e.PerspectiveCamera(50,1,.01,1e3),this.DEFAULT_CAMERA.name="Camera",this.DEFAULT_CAMERA.position.set(0,5,10),this.DEFAULT_CAMERA.lookAt(new e.Vector3);var h=t.Signal;this.signals={editScript:new h,startPlayer:new h,stopPlayer:new h,editorCleared:new h,savingStarted:new h,savingFinished:new h,transformModeChanged:new h,snapChanged:new h,spaceChanged:new h,rendererChanged:new h,rendererUpdated:new h,sceneBackgroundChanged:new h,sceneFogChanged:new h,sceneGraphChanged:new h,sceneRendered:new h,cameraChanged:new h,geometryChanged:new h,objectSelected:new h,objectFocused:new h,objectAdded:new h,objectChanged:new h,objectRemoved:new h,cameraAdded:new h,cameraRemoved:new h,helperAdded:new h,helperRemoved:new h,materialAdded:new h,materialChanged:new h,materialRemoved:new h,scriptAdded:new h,scriptChanged:new h,scriptRemoved:new h,windowResize:new h,showGridChanged:new h,refreshSidebarObject3D:new h,historyChanged:new h,viewportCameraChanged:new h},this.config=new i,this.history=new a(this),this.storage=new r,this.strings=new n(this.config),this.loader=new s(this),this.camera=this.DEFAULT_CAMERA.clone(),this.scene=new e.Scene,this.scene.name="Scene",this.scene.background=new e.Color(11184810),this.sceneHelpers=new e.Scene,this.object={},this.geometries={},this.materials={},this.textures={},this.scripts={},this.materialsRefCounter=new Map,this.animations={},this.mixer=new e.AnimationMixer(this.scene),this.selected=null,this.helpers={},this.cameras={},this.viewportCamera=this.camera,this.addCamera(this.camera)};return d.prototype={setScene:function(e){for(this.scene.uuid=e.uuid,this.scene.name=e.name,this.scene.background=null!==e.background?e.background.clone():null,null!==e.fog&&(this.scene.fog=e.fog.clone()),this.scene.userData=JSON.parse(JSON.stringify(e.userData)),this.signals.sceneGraphChanged.active=!1;e.children.length>0;)this.addObject(e.children[0]);this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},addObject:function(e,t,i){var s=this;e.traverse(function(e){void 0!==e.geometry&&s.addGeometry(e.geometry),void 0!==e.material&&s.addMaterial(e.material),s.addCamera(e),s.addHelper(e)}),void 0===t?this.scene.add(e):(t.children.splice(i,0,e),e.parent=t),this.signals.objectAdded.dispatch(e),this.signals.sceneGraphChanged.dispatch()},moveObject:function(e,t,i){if(void 0===t&&(t=this.scene),t.add(e),void 0!==i){var s=t.children.indexOf(i);t.children.splice(s,0,e),t.children.pop()}this.signals.sceneGraphChanged.dispatch()},nameObject:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},removeObject:function(e){if(null!==e.parent){var t=this;e.traverse(function(e){t.removeCamera(e),t.removeHelper(e),void 0!==e.material&&t.removeMaterial(e.material)}),e.parent.remove(e),this.signals.objectRemoved.dispatch(e),this.signals.sceneGraphChanged.dispatch()}},addGeometry:function(e){this.geometries[e.uuid]=e},setGeometryName:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},addMaterial:function(e){if(Array.isArray(e))for(var t=0,i=e.length;t<i;t++)this.addMaterialToRefCounter(e[t]);else this.addMaterialToRefCounter(e);this.signals.materialAdded.dispatch()},addMaterialToRefCounter:function(e){var t=this.materialsRefCounter,i=t.get(e);void 0===i?(t.set(e,1),this.materials[e.uuid]=e):(i++,t.set(e,i))},removeMaterial:function(e){if(Array.isArray(e))for(var t=0,i=e.length;t<i;t++)this.removeMaterialFromRefCounter(e[t]);else this.removeMaterialFromRefCounter(e);this.signals.materialRemoved.dispatch()},removeMaterialFromRefCounter:function(e){var t=this.materialsRefCounter,i=t.get(e);0===--i?(t.delete(e),delete this.materials[e.uuid]):t.set(e,i)},getMaterialById:function(e){for(var t,i=Object.values(this.materials),s=0;s<i.length;s++)if(i[s].id===e){t=i[s];break}return t},setMaterialName:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},addTexture:function(e){this.textures[e.uuid]=e},addAnimation:function(e,t){t.length>0&&(this.animations[e.uuid]=t)},addCamera:function(e){e.isCamera&&(this.cameras[e.uuid]=e,this.signals.cameraAdded.dispatch(e))},removeCamera:function(e){void 0!==this.cameras[e.uuid]&&(delete this.cameras[e.uuid],this.signals.cameraRemoved.dispatch(e))},addHelper:(h=new e.SphereBufferGeometry(2,4,2),c=new e.MeshBasicMaterial({color:16711680,visible:!1}),function(t){var i;if(t.isCamera)i=new e.CameraHelper(t);else if(t.isPointLight)i=new e.PointLightHelper(t,1);else if(t.isDirectionalLight)i=new e.DirectionalLightHelper(t,1);else if(t.isSpotLight)i=new e.SpotLightHelper(t,1);else if(t.isHemisphereLight)i=new e.HemisphereLightHelper(t,1);else{if(!t.isSkinnedMesh)return;i=new e.SkeletonHelper(t.skeleton.bones[0])}var s=new e.Mesh(h,c);s.name="picker",s.userData.object=t,i.add(s),this.sceneHelpers.add(i),this.helpers[t.id]=i,this.signals.helperAdded.dispatch(i)}),removeHelper:function(e){if(void 0!==this.helpers[e.id]){var t=this.helpers[e.id];t.parent.remove(t),delete this.helpers[e.id],this.signals.helperRemoved.dispatch(t)}},addScript:function(e,t){void 0===this.scripts[e.uuid]&&(this.scripts[e.uuid]=[]),this.scripts[e.uuid].push(t),this.signals.scriptAdded.dispatch(t)},removeScript:function(e,t){if(void 0!==this.scripts[e.uuid]){var i=this.scripts[e.uuid].indexOf(t);-1!==i&&this.scripts[e.uuid].splice(i,1),this.signals.scriptRemoved.dispatch(t)}},getObjectMaterial:function(e,t){var i=e.material;return Array.isArray(i)&&void 0!==t&&(i=i[t]),i},setObjectMaterial:function(e,t,i){Array.isArray(e.material)&&void 0!==t?e.material[t]=i:e.material=i},setViewportCamera:function(e){this.viewportCamera=this.cameras[e],this.signals.viewportCameraChanged.dispatch(this.viewportCamera)},select:function(e){if(this.selected!==e){var t=null;null!==e&&(t=e.uuid),this.selected=e,this.config.setKey("selected",t),this.signals.objectSelected.dispatch(e)}},selectById:function(e){e!==this.camera.id?this.select(this.scene.getObjectById(e,!0)):this.select(this.camera)},selectByUuid:function(e){var t=this;this.scene.traverse(function(i){i.uuid===e&&t.select(i)})},deselect:function(){this.select(null)},focus:function(e){void 0!==e&&this.signals.objectFocused.dispatch(e)},focusById:function(e){this.focus(this.scene.getObjectById(e,!0))},clear:function(){this.history.clear(),this.storage.clear(),this.camera.copy(this.DEFAULT_CAMERA),this.scene.name="Scene",this.scene.userData={},this.scene.background=new e.Color(11184810),this.scene.fog=null;for(var t=this.scene.children;t.length>0;)this.removeObject(t[0]);this.geometries={},this.materials={},this.textures={},this.scripts={},this.materialsRefCounter.clear(),this.animations={},this.mixer.stopAllAction(),this.deselect(),this.signals.editorCleared.dispatch()},fromJSON:function(t){var i=this,s=new e.ObjectLoader,a=s.parse(t.camera);this.camera.copy(a),this.camera.aspect=this.DEFAULT_CAMERA.aspect,this.camera.updateProjectionMatrix(),this.history.fromJSON(t.history),this.scripts=t.scripts,s.parse(t.scene,function(e){i.setScene(e)})},toJSON:function(){var e=this.scene,t=this.scripts;for(var i in t){0!==t[i].length&&void 0!==e.getObjectByProperty("uuid",i)||delete t[i]}return{metadata:{},project:{shadows:this.config.getKey("project/renderer/shadows"),vr:this.config.getKey("project/vr")},camera:this.camera.toJSON(),scene:this.scene.toJSON(),scripts:this.scripts,history:this.history.toJSON()}},objectByUuid:function(e){return this.scene.getObjectByProperty("uuid",e,!0)},execute:function(e,t){this.history.execute(e,t)},undo:function(){this.history.undo()},redo:function(){this.history.redo()}},d});
//# sourceMappingURL=sourcemaps/Editor.js.map
